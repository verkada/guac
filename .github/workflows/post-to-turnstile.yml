name: Post to Turnstile
description: "Reusable workflow to post workflow results to S3 turnstile"

on:
  workflow_call:
    inputs:
      job_success:
        description: "Whether the calling job succeeded"
        required: true
        type: boolean
      job_result:
        description: "The result status of the calling job"
        required: true
        type: string
      workflow_name:
        description: "Name of the calling workflow"
        required: true
        type: string
      run_id:
        description: "GitHub run ID"
        required: true
        type: string
      run_number:
        description: "GitHub run number"
        required: true
        type: string
      start_time:
        description: "When the job started (Unix timestamp)"
        required: true
        type: string
      github_event_schedule:
        description: "Cron schedule if triggered by schedule"
        required: false
        type: string
        default: ""
      github_repo_name:
        description: "GitHub repository name"
        required: false
        type: string
        default: ""
      s3_bucket:
        description: "S3 bucket for storing workflow results"
        required: false
        type: string
        default: "verkada-device-platform-vlnx-ci"
      aws_role_arn:
        description: "AWS IAM role ARN to assume for S3 access"
        required: true
        type: string

jobs:
  PostToTurnstile:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          role-duration-seconds: 900
          role-to-assume: ${{ inputs.aws_role_arn }}
          role-session-name: GithubActionTurnstile
          aws-region: us-west-2

      - name: Post to turnstile
        env:
          JOB_SUCCESS: ${{ inputs.job_success }}
          JOB_RESULT: ${{ inputs.job_result }}
          WORKFLOW_NAME: ${{ inputs.workflow_name }}
          RUN_ID: ${{ inputs.run_id }}
          RUN_NUMBER: ${{ inputs.run_number }}
          START_TIME: ${{ inputs.start_time }}
          GITHUB_EVENT_SCHEDULE: ${{ inputs.github_event_schedule }}
          GITHUB_REPO_NAME: ${{ inputs.github_repo_name }}
          GITHUB_SHA: ${{ github.sha }}
          S3_BUCKET: ${{ inputs.s3_bucket }}
        run: |
          # Create temp directory
          TEMP_DIR="$(mktemp -d)"
          
          # Capture end time for runtime calculation
          END_TIME="$(date -u +%s)"
          
          # Calculate runtime in seconds if we have start time
          if [[ "${START_TIME}" =~ ^[0-9]+$ ]]; then
              # START_TIME is already a Unix timestamp
              RUNTIME="$((${END_TIME} - ${START_TIME}))"
          elif [[ "${START_TIME}" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$ ]]; then
              # START_TIME is an ISO format string, convert to timestamp
              START_EPOCH="$(date -u -d "${START_TIME}" +%s)"
              RUNTIME="$((${END_TIME} - ${START_EPOCH}))"
          else
              RUNTIME=0
          fi
          
          # Determine success status from job result
          SUCCESS=true
          if [ "${JOB_SUCCESS}" != "true" ]; then
              SUCCESS=false
          fi
          
          # Use the provided cron schedule input directly
          CRON_SCHEDULE="${GITHUB_EVENT_SCHEDULE}"
          echo "Cron schedule: ${CRON_SCHEDULE}"
          
          # Validate required fields before creating JSON
          echo "Validating required fields..."
          
          # Validate start_time is present and valid
          if [ -z "${START_TIME}" ]; then
            echo "❌ Error: start_time is required but missing"
            exit 1
          fi
          
          # Validate start_time is a valid timestamp
          if ! [[ "${START_TIME}" =~ ^[0-9]+$ ]] && ! [[ "${START_TIME}" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$ ]]; then
            echo "❌ Error: start_time must be a Unix timestamp or ISO format"
            exit 1
          fi
          
          # Validate cron_schedule is present and not empty
          if [ -z "${CRON_SCHEDULE}" ]; then
            echo "❌ Error: cron_schedule is required but missing"
            exit 1
          fi
          
          echo "✅ All required fields validated"
          
          # Create workflow run URL
          WORKFLOW_URL="https://github.com/${GITHUB_REPO_NAME}/actions/runs/${RUN_ID}"
          
          # Create JSON result file using jq to handle special characters safely
          jq -n \
            --arg workflow "${WORKFLOW_NAME}" \
            --arg run_id "${RUN_ID}" \
            --arg run_number "${RUN_NUMBER}" \
            --arg repository "${GITHUB_REPO_NAME}" \
            --arg commit "${GITHUB_SHA}" \
            --arg started_at "${START_TIME}" \
            --arg completed_at "${END_TIME}" \
            --arg runtime_seconds "${RUNTIME}" \
            --arg success "${SUCCESS}" \
            --arg cron_schedule "${CRON_SCHEDULE}" \
            --arg workflow_url "${WORKFLOW_URL}" \
            '{
              workflow: $workflow,
              run_id: $run_id,
              run_number: $run_number,
              repository: $repository,
              commit: $commit,
              started_at: $started_at,
              completed_at: $completed_at,
              runtime_seconds: $runtime_seconds,
              success: $success,
              cron_schedule: $cron_schedule,
              workflow_url: $workflow_url
            }' > "${TEMP_DIR}/result.json"
          
          # Upload to S3
          echo "Uploading result to S3..."
          
          # Strip "verkada/" prefix from repository name for cleaner S3 paths
          if [[ "${GITHUB_REPO_NAME}" == "verkada/"* ]]; then
              CLEAN_REPO_NAME="${GITHUB_REPO_NAME#verkada/}"
          else
              CLEAN_REPO_NAME="${GITHUB_REPO_NAME}"
          fi
          
          # Sanitize workflow name to replace forward slashes with hyphens for clean S3 paths
          CLEAN_WORKFLOW_NAME="${WORKFLOW_NAME//\//-}"
          
          S3_PREFIX="s3://${S3_BUCKET}/workflow_results/${CLEAN_REPO_NAME}/${CLEAN_WORKFLOW_NAME}"
          S3_PATH="${S3_PREFIX}/result-${START_TIME}.json"
          S3_PATH_LATEST="${S3_PREFIX}/result-latest.json"
          
          # Upload the JSON file
          aws s3 cp "${TEMP_DIR}/result.json" "${S3_PATH}"
          aws s3 cp "${TEMP_DIR}/result.json" "${S3_PATH_LATEST}"
          
          echo "Result uploaded to S3: ${S3_PATH}"
          
          # Clean up temp directory
          rm -rf "${TEMP_DIR}"
